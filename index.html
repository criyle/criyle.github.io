<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://criyle.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Lonely World">
<meta property="og:url" content="http:&#x2F;&#x2F;criyle.github.io&#x2F;index.html">
<meta property="og:site_name" content="Lonely World">
<meta property="article:author" content="criyle">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://criyle.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Lonely World</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lonely World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="default">
    <link itemprop="mainEntityOfPage" href="http://criyle.github.io/2020/01/19/sandboxed-judger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="criyle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lonely World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/19/sandboxed-judger/" class="post-title-link" itemprop="url">Running a judger inside a container sandbox</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-01-19 19:19:08 / Modified: 20:24:27" itemprop="dateCreated datePublished" datetime="2020-01-19T19:19:08-05:00">2020-01-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>It have been a long time after last post and the sandbox technology have been improved a lot. By combining unix socket and container pooling from <a href="https://github.com/vijos/jd4" target="_blank" rel="noopener">vijos/jd4</a> and cgroup checking and unshare container from <a href="https://github.com/syzoj/judge-v3" target="_blank" rel="noopener">syzoj/judge-v3</a>, the judge is able to safely run arbitrary code in isolated environment.</p>
<h2 id="Design-of-judge-v3-and-jd4"><a href="#Design-of-judge-v3-and-jd4" class="headerlink" title="Design of judge-v3 and jd4"></a>Design of judge-v3 and jd4</h2><p>In the design of <code>judge-v3</code>, The daemon receives task from website and then pass into runner to execute. The runner would start the running task through simple-sandbox. The simple-sandbox run a program requires creating / destroying containers repeatedly. The container is created through a dedicated readonly rootfs with bind mounting output directories. The container is created through unshare and chroot and privilege is dropped by changing process user.</p>
<p>In the design of <code>jd4</code>, containers are created in advance through fork and unshare. File system is shared through read-only or read-write output bind mounts to the host file system. Child process inside the container is connected through a unix socket and controlled through a RPC interface. New process pid is passed by creating new unix socket as file inside the bind mount and the process pass credential through oob data. The lifetime of the new process is managed through the parent process.</p>
<h2 id="Design-of-pre-forked-GO-sandbox"><a href="#Design-of-pre-forked-GO-sandbox" class="headerlink" title="Design of pre-forked GO-sandbox"></a>Design of pre-forked GO-sandbox</h2><p>By taking the design of both implementation, the <code>go-sandbox</code> chooses dumb, pre-forked and isolated runner. The file system of the sandbox is created through read-only bind mounting from host file system with 2 small tmpfs. Command is passed through a unix socket pair together with files and child pid. To ensure security, the privilege is dropped through changing process user or set capabilities.</p>
<p>The RPC interface between host and container daemon are:</p>
<ul>
<li><code>ping</code>: alive check</li>
<li><code>conf</code>: set the running configuration (user / group)</li>
<li><code>open</code>: open / create multiple files inside the container</li>
<li><code>delete</code>: unlink / rmdir file inside the container</li>
<li><code>reset</code>: remove all files under /w and /tmp</li>
<li><code>execve</code>: execute and wait single process inside the container</li>
</ul>
<h2 id="Potential-attacks"><a href="#Potential-attacks" class="headerlink" title="Potential attacks"></a>Potential attacks</h2><ul>
<li>forever sleep: pooling through CPU usage and assumes at least 40% utilization</li>
<li>creates arbitrary files: readonly &amp; tmpfs limited at 8MB</li>
<li>large executable: tmpfs limited at 8MB</li>
<li>c / c++ includes <code>/etc/passwd</code>: not bind mounted</li>
<li>network download: unshared net</li>
<li>overwrite <code>/proc/1/exe</code>: unprivileged</li>
<li>open <code>/proc/1/fds/3</code>: unprivileged</li>
<li>fork bomb: cgroup pid max</li>
<li>large memory: cgroup memory</li>
</ul>
<h2 id="Design-of-GO-judge"><a href="#Design-of-GO-judge" class="headerlink" title="Design of GO-judge"></a>Design of GO-judge</h2><p>By taking the design from <code>judge-v3</code>, the <code>go-judge</code> have 2 layers. The client interface connect to the website to receive the tasks and test data. The first layer parses the task and data from the client interface and pass into the message queue interface for the runner. The runner receives run tasks from the queue and run through the <code>go-sandbox</code> and pass back the run results.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Long time not writing documents… I am too lazy…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="default">
    <link itemprop="mainEntityOfPage" href="http://criyle.github.io/2019/04/13/uoj-judger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="criyle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lonely World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/13/uoj-judger/" class="post-title-link" itemprop="url">A GO reimplement of UOJ judger</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-13 20:51:44" itemprop="dateCreated datePublished" datetime="2019-04-13T20:51:44-04:00">2019-04-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-19 20:04:57" itemprop="dateModified" datetime="2020-01-19T20:04:57-05:00">2020-01-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Reimplement of UOJ run program in GO: <a href="https://github.com/criyle/go-judger" target="_blank" rel="noopener">go-judger</a>. Start after I found libseccomp that uses seccomp filter introduced in linux 3.8 (2013). Since I have participated that project (<a href="https://github.com/vfleaking/uoj" target="_blank" rel="noopener">uoj</a>) only a little, I decided to try to do some contributions.</p>
<h2 id="Original-implements"><a href="#Original-implements" class="headerlink" title="Original implements"></a>Original implements</h2><p>The original run program restricted resources (CPU, memory, output) and file access by <code>ptrace</code>. Including following steps:</p>
<p>Setup up step after fork in child:</p>
<ol>
<li>Set resource limits by <code>setrlimit</code></li>
<li>Set environment variables</li>
<li>Set input / output files</li>
<li><code>execv</code></li>
</ol>
<p>Tracing after fork in parent:</p>
<p>Setup <code>ptrace</code> options when trapped at <code>execv</code></p>
<ol>
<li><code>wait4</code> at syscall entrance</li>
<li>Check resource usage, wait status, signals and syscall black list to determine terminate or soft ban</li>
<li><code>ptrace syscall</code> enter syscall</li>
<li><code>wait4</code> at syscall exits</li>
<li>Set syscall return value</li>
<li><code>ptrace syscall</code> exit syscall</li>
</ol>
<p>In this scenario, the traced process required to stop for each syscall and for both entrance and exiting. For harmless syscalls (e.g. <code>brk</code>, <code>read</code>), this introduces some resource overhead.</p>
<h2 id="Reimplements"><a href="#Reimplements" class="headerlink" title="Reimplements"></a>Reimplements</h2><p>For the newly implemented <code>seccomp</code> BPF filter provided by <code>libseccomp</code>, this kind of syscall will handled by the kernel to avoid too much context switch. Also, for a single traced syscall, <code>seccomp</code> will only be triggered once.</p>
<p>Thus, the new implement becomes.</p>
<p>Setup step after fork in child:</p>
<ol>
<li>Set resource limits by <code>setrlimit</code></li>
<li>Set input / output files</li>
<li>Load <code>seccomp</code> filter</li>
<li>Stop itself by <code>SIGSTOP</code></li>
<li><code>execve</code> with environment variables</li>
</ol>
<p>Tracing after fork in parent:</p>
<p>Setup <code>ptrace</code> options when trapped by <code>SIGSTOP</code></p>
<ol>
<li><code>wait4</code> at seccomp event</li>
<li>Check resource usage, wait status, signals, and call syscall event handles. Handle determins whether to terminates or soft ban</li>
<li><code>ptrace continue</code> enter syscall</li>
</ol>
<p>Notice that <code>SIGSTOP</code> before <code>execve</code> is required since if <code>execve</code> is traced but the <code>ptrace</code> option have not set up yet, <code>ENOSYS</code> will returned to <code>execve</code>. Safe syscalls was allowed by the filter so there is no <code>ptrace</code> event triggered by safe syscalls.</p>
<p>Also, by setting syscall number to <code>-1</code> and return value to the register, the soft ban mechanism becomes much efficient.</p>
<p>With all that implemented, <code>process_vm_readv</code> is used to speed up copy syscall argument instead of <code>ptrace peekdata</code>.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In conclusion, by restrict CPU time, memory, output, syscalls and file access, run program is able to block potential attacks.</p>
<p>Since GO language does not provides official implements for <code>fork</code> for runtime duplication issue, it took some time to figure out the usage of raw syscall interface. Because after fork in child, I cannot call any go function, I did buffed the seccomp filter to allow load it after fork. Also, <code>process_vm_readv</code> is not provided so I wrote a wrapper for it.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="default">
    <link itemprop="mainEntityOfPage" href="http://criyle.github.io/2018/06/14/discord-bot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="criyle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lonely World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/14/discord-bot/" class="post-title-link" itemprop="url">A discord bot for Bilibili</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2018-06-14 14:09:03 / Modified: 13:09:45" itemprop="dateCreated datePublished" datetime="2018-06-14T14:09:03-04:00">2018-06-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>GitHub: <a href="https://github.com/criyle/DiscordBilibiliBot" target="_blank" rel="noopener">DiscordBilibiliBot</a></p>
<p>After about one month of development, this discord bot finally have the expected behavior, but it still need some polishment.</p>
<h2 id="Reason-for-developing-such-a-bot"><a href="#Reason-for-developing-such-a-bot" class="headerlink" title="Reason for developing such a bot"></a>Reason for developing such a bot</h2><p>There are lots of discord bots that plays YouTube wideos as audio in discord audio channel, but there were not decent ones for Bilibili. Since I am a fan of Vocaloid China mainly posted on Bilibili, I started writing this bot.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/06/14/discord-bot/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="default">
    <link itemprop="mainEntityOfPage" href="http://criyle.github.io/2018/06/11/test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="criyle">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lonely World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/06/11/test/" class="post-title-link" itemprop="url">Hello World</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-06-11 22:41:09" itemprop="dateCreated datePublished" datetime="2018-06-11T22:41:09-04:00">2018-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2018-06-14 12:32:26" itemprop="dateModified" datetime="2018-06-14T12:32:26-04:00">2018-06-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>Adapted to using Hexo.</p>
<p><code>inline code</code></p>
<p>C++ Highlight</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> a, b;</span><br><span class="line">  <span class="built_in">cin</span> &gt;&gt; a &gt;&gt; b;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; a + b &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python Highlight</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a, b = map(int, input().split(<span class="string">' '</span>))</span><br><span class="line">print(a + b)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">criyle</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">criyle</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.1.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
